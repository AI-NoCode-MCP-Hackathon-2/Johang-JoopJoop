<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:,">
  <title>근로계약서 위험도 하이라이트 뷰어</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #0b1221;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
      --accent: #22d3ee;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Noto Sans KR", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(34,211,238,0.15), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(236,72,153,0.12), transparent 20%),
                  var(--bg);
      color: var(--text);
      padding: 28px;
    }
    h1 { margin: 0; font-weight: 800; letter-spacing: -0.02em; }
    p { color: var(--muted); margin: 8px 0; line-height: 1.5; }
    .eyebrow { letter-spacing: 0.16em; text-transform: uppercase; font-size: 12px; color: #7dd3fc; }
    .header { max-width: 1100px; margin: 0 auto 18px; display: flex; flex-direction: column; gap: 10px; }
    .legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 13px; font-weight: 700; color: var(--text); border: 1px solid var(--border); background: rgba(255,255,255,0.04); }
    .color-dot { width: 10px; height: 10px; border-radius: 999px; }
    .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items: start; }
    .panel { background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
    #pdf-container { display: flex; flex-direction: column; gap: 16px; }

    /* PDF.js 페이지 스타일 */
    .pdf-page {
      position: relative;
      margin: 0 auto;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      background: white;
    }
    .pdf-page canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      opacity: 1;
      line-height: 1.0;
    }
    .textLayer > span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
    }
    /* 하이라이트 효과 */
    .textLayer > span.highlight-red {
      background-color: rgba(239,68,68,0.4) !important;
      color: transparent;
    }
    .textLayer > span.highlight-orange {
      background-color: rgba(249,115,22,0.35) !important;
      color: transparent;
    }
    .textLayer > span.highlight-yellow {
      background-color: rgba(234,179,8,0.35) !important;
      color: transparent;
    }

    #pdf-status { margin: 0 0 8px; font-size: 14px; color: var(--muted); }
    .clause-list { display: flex; flex-direction: column; gap: 12px; }
    .clause { border: 1px solid var(--border); padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }
    .clause h4 { margin: 0 0 6px; font-size: 15px; }
    .clause .meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .clause .note { margin: 6px 0 0; color: #cbd5e1; font-size: 13px; line-height: 1.4; }
    @media (max-width: 1100px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="eyebrow">Live highlight</div>
    <h1>근로계약서 위험도 하이라이트</h1>
    <p>JSON에 담긴 독소 조항 리스트를 불러와 위험도별로 색을 입히고, PDF 텍스트를 추출한 화면에 하이라이트합니다.</p>
    <div class="legend">
      <span class="chip"><span class="color-dot" style="background:#ef4444"></span>RED 위험</span>
      <span class="chip"><span class="color-dot" style="background:#f97316"></span>ORANGE 위험</span>
      <span class="chip"><span class="color-dot" style="background:#eab308"></span>YELLOW 위험</span>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <p id="pdf-status">PDF와 데이터를 불러오는 중...</p>
      <div id="pdf-container"></div>
    </section>

    <aside class="panel">
      <div class="meta" style="margin-bottom:10px;">
        <h3 style="margin:0;">위험 조항</h3>
        <span class="chip" style="background:rgba(34,211,238,0.12); border-color:#22d3ee; color:#67e8f9;">자동 하이라이트</span>
      </div>
      <div id="clause-list" class="clause-list"></div>
    </aside>
  </main>

  <!-- pdf.js를 CDN에서 로드해 텍스트만 추출합니다. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // CMap 설정 (한글 폰트 처리)
    const CMAP_URL = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/';
    const CMAP_PACKED = true;

    const riskPalette = {
      RED:   { fill: 'rgba(239,68,68,0.28)', line: '#ef4444', label: 'RED' },
      ORANGE:{ fill: 'rgba(249,115,22,0.25)', line: '#f97316', label: 'ORANGE' },
      YELLOW:{ fill: 'rgba(234,179,8,0.25)', line: '#eab308', label: 'YELLOW' }
    };

    // PDF URL은 쿼리 파라미터로 받거나 기본값 사용
    const urlParams = new URLSearchParams(window.location.search);
    const pdfUrl = urlParams.get('pdf') || '근로계약서_독소조항포함.pdf';
    const dataUrl = urlParams.get('data') || '새 텍스트 문서 (2).json';

    // 외부에서 postMessage로 데이터를 받을 수 있는 변수
    let externalData = null;

    const normalize = (str = '') => str.replace(/\s+/g, '').replace(/\u00ad/g, '').trim();
    const buildSnippet = (text = '') => normalize(text).slice(0, 8);

    const renderClauseList = (clauses) => {
      const host = document.getElementById('clause-list');
      host.innerHTML = '';
      clauses.forEach((item, idx) => {
        const riskKey = String(item['위험도 색상'] || item['위험도'] || '').toUpperCase();
        const palette = riskPalette[riskKey] || { fill: 'rgba(148,163,184,0.2)', line: '#94a3b8', label: riskKey || 'N/A' };
        const box = document.createElement('article');
        box.className = 'clause';
        box.style.borderColor = palette.line;
        box.innerHTML = `
          <div class="meta">
            <span class="chip" style="border-color:${palette.line}; color:${palette.line}; background:${palette.fill};">${palette.label}</span>
            <span style="color:var(--muted); font-size:12px;">#${idx + 1}</span>
          </div>
          <h4>${item['조항'] || '조항 없음'}</h4>
          <p class="note">${item['설명'] || ''}</p>
        `;
        host.appendChild(box);
      });
    };

    // 텍스트 정규화 (공백, 특수문자 제거)
    const normalizeText = (text) => {
      return text.replace(/\s+/g, '').toLowerCase();
    };

    // 텍스트 레이어의 span들에 하이라이트 적용
    const highlightTextLayer = (textLayerDiv, clauses) => {
      if (!textLayerDiv || clauses.length === 0) {
        console.log('하이라이트 중단: textLayer 없음 또는 조항 없음');
        return;
      }

      const spans = Array.from(textLayerDiv.querySelectorAll('span'));
      console.log(`페이지 span 개수: ${spans.length}, 조항 개수: ${clauses.length}`);

      // 전체 페이지 텍스트 수집
      const pageText = spans.map(s => s.textContent).join('');
      console.log('페이지 텍스트 샘플:', pageText.slice(0, 200));

      clauses.forEach((clause, clauseIdx) => {
        const targetText = clause['조항'] || '';
        if (!targetText) return;

        const riskKey = String(clause['위험도 색상'] || clause['위험도'] || '').toUpperCase();
        let highlightClass = '';

        if (riskKey === 'RED') highlightClass = 'highlight-red';
        else if (riskKey === 'ORANGE') highlightClass = 'highlight-orange';
        else if (riskKey === 'YELLOW') highlightClass = 'highlight-yellow';

        if (!highlightClass) return;

        console.log(`\n조항 #${clauseIdx + 1} (${riskKey}):`, targetText.slice(0, 50) + '...');

        // "제목: 내용" 형태에서 콜론 뒤의 핵심 내용만 추출
        let coreText = targetText;
        if (targetText.includes(':')) {
          coreText = targetText.split(':').slice(1).join(':').trim();
          console.log('콜론 뒤 핵심 내용:', coreText.slice(0, 50) + '...');
        }

        // 정규화된 타겟 텍스트
        const normalizedTarget = normalizeText(coreText);
        console.log('정규화된 타겟:', normalizedTarget.slice(0, 50) + '...');

        // 너무 짧은 텍스트는 스킵 (오매칭 방지)
        if (normalizedTarget.length < 10) {
          console.log('✗ 텍스트가 너무 짧아서 스킵');
          return;
        }

        let foundMatch = false;

        // 연속된 span들을 합쳐서 매칭 시도
        for (let i = 0; i < spans.length && !foundMatch; i++) {
          let accumulated = '';
          let matchedSpans = [];

          for (let j = i; j < spans.length; j++) {
            accumulated += spans[j].textContent;
            matchedSpans.push(spans[j]);

            const normalizedAccumulated = normalizeText(accumulated);

            // 타겟 텍스트가 누적된 텍스트에 포함되어 있는지 확인
            if (normalizedAccumulated.includes(normalizedTarget)) {
              console.log(`✓ 매칭 성공! span ${i}~${j} (${matchedSpans.length}개)`);
              matchedSpans.forEach(span => span.classList.add(highlightClass));
              foundMatch = true;
              break;
            }

            // 부분 매칭 확인 - 타겟의 시작 부분이 누적 텍스트와 일치하는지
            if (normalizedTarget.startsWith(normalizedAccumulated)) {
              // 계속 누적
              continue;
            } else if (normalizedAccumulated.length > normalizedTarget.length * 1.5) {
              // 너무 길어지면 중단
              break;
            }

            // 너무 길어지면 중단 (성능 최적화)
            if (matchedSpans.length > 100) break;
          }
        }

        if (!foundMatch) {
          console.log('✗ 매칭 실패');
        }
      });
    };

    const renderDocument = async (customData = null) => {
      const status = document.getElementById('pdf-status');
      try {
        // PDF 먼저 로드 (CMap 설정 포함)
        const pdf = await pdfjsLib.getDocument({
          url: pdfUrl,
          cMapUrl: CMAP_URL,
          cMapPacked: CMAP_PACKED
        }).promise;

        // JSON 데이터 로드 우선순위:
        // 1. customData (postMessage로 받은 데이터)
        // 2. externalData (전역 변수로 설정된 데이터)
        // 3. fetch로 dataUrl에서 로드
        let data = {};

        if (customData) {
          console.log('✓ 외부 데이터(파라미터) 사용');
          data = customData;
        } else if (externalData) {
          console.log('✓ 외부 데이터(전역) 사용');
          data = externalData;
        } else {
          try {
            const res = await fetch(encodeURI(dataUrl));
            if (res.ok) {
              data = await res.json();
              console.log('✓ JSON 파일에서 로드');
            } else {
              console.warn('JSON 로드 실패(상태코드)', res.status);
            }
          } catch (e) {
            console.warn('JSON 로드 실패', e);
          }
        }

        const clauses = data['독소 조항 리스트'] || data['위험 조항 리스트'] || data.clauses || [];
        renderClauseList(clauses);

        const viewer = document.getElementById('pdf-container');
        status.textContent = '';

        // 각 페이지 렌더링
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);

          // 캔버스 생성 및 렌더링
          const viewport = page.getViewport({ scale: 1.5 });
          const pageDiv = document.createElement('div');
          pageDiv.className = 'pdf-page';
          pageDiv.style.width = viewport.width + 'px';
          pageDiv.style.height = viewport.height + 'px';

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          pageDiv.appendChild(canvas);
          viewer.appendChild(pageDiv);

          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;

          // 텍스트 레이어 생성
          const textLayerDiv = document.createElement('div');
          textLayerDiv.className = 'textLayer';
          textLayerDiv.style.width = viewport.width + 'px';
          textLayerDiv.style.height = viewport.height + 'px';
          textLayerDiv.style.setProperty('--scale-factor', viewport.scale);
          pageDiv.appendChild(textLayerDiv);

          const textContent = await page.getTextContent();

          // PDF.js 텍스트 레이어 렌더링
          pdfjsLib.renderTextLayer({
            textContentSource: textContent,
            container: textLayerDiv,
            viewport: viewport,
            textDivs: []
          }).promise.then(() => {
            // 텍스트 레이어가 완성되면 하이라이트 적용
            highlightTextLayer(textLayerDiv, clauses);
          });
        }

        status.textContent = `PDF ${pdf.numPages}페이지 로드 완료`;
      } catch (err) {
        console.error(err);
        status.textContent = `불러오기 실패: ${err.message}`;
      }
    };

    // postMessage 이벤트 리스너 - 외부(iframe 부모)에서 데이터 받기
    window.addEventListener('message', (event) => {
      console.log(':incoming_envelope: postMessage 수신:', event.origin);

      // 보안: 신뢰할 수 있는 출처인지 확인 (선택사항)
      // if (event.origin !== 'https://ragflow.dpgtestbed.kr') return;

      if (event.data && event.data.type === 'PDF_ANALYSIS_RESULT') {
        console.log('✓ PDF 분석 결과 수신');
        externalData = event.data.data;

        // PDF 컨테이너 초기화 후 재렌더링
        const viewer = document.getElementById('pdf-container');
        viewer.innerHTML = '';

        renderDocument(event.data.data);
      }
    });

    // 전역 함수로 노출 - 외부에서 직접 호출 가능
    window.updateAnalysisData = (data) => {
      console.log('✓ updateAnalysisData 호출됨');
      externalData = data;

      const viewer = document.getElementById('pdf-container');
      viewer.innerHTML = '';

      renderDocument(data);
    };

    // 페이지 로드 시 초기 렌더링
    renderDocument();

    // 부모 창에 로드 완료 알림
    if (window.parent !== window) {
      window.parent.postMessage({
        type: 'PDF_VIEWER_READY'
      }, '*');
    }
  </script>
</body>
</html>

백업