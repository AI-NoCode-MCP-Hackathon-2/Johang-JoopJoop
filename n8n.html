<!doctype html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:,">
  <title>ê·¼ë¡œê³„ì•½ì„œ ìœ„í—˜ë„ í•˜ì´ë¼ì´íŠ¸ ë·°ì–´</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #0b1221;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
      --accent: #22d3ee;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Noto Sans KR", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.15), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(236, 72, 153, 0.12), transparent 20%),
        var(--bg);
      color: var(--text);
      padding: 28px;
    }

    h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    p {
      color: var(--muted);
      margin: 8px 0;
      line-height: 1.5;
    }

    .eyebrow {
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-size: 12px;
      color: #7dd3fc;
    }

    .header {
      max-width: 1100px;
      margin: 0 auto 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
    }

    .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .panel {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    #pdf-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* PDF.js í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
    .pdf-page {
      position: relative;
      margin: 0 auto;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
      background: white;
    }

    .pdf-page canvas {
      display: block;
      width: 100%;
      height: auto;
    }

    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      opacity: 1;
      line-height: 1.0;
      --scale-factor: 1.0;
    }

    .textLayer>span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
    }

    /* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
    .textLayer>span.highlight-red {
      background-color: rgba(239, 68, 68, 0.4) !important;
      color: transparent;
    }

    .textLayer>span.highlight-orange {
      background-color: rgba(249, 115, 22, 0.35) !important;
      color: transparent;
    }

    .textLayer>span.highlight-yellow {
      background-color: rgba(234, 179, 8, 0.35) !important;
      color: transparent;
    }

    #pdf-status {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .clause-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .clause {
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .clause h4 {
      margin: 0 0 6px;
      font-size: 15px;
    }

    .clause .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .clause .note {
      margin: 6px 0 0;
      color: #cbd5e1;
      font-size: 13px;
      line-height: 1.4;
    }

    /* ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(34, 211, 238, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .status.loading {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="eyebrow">Live highlight</div>
    <h1>ê·¼ë¡œê³„ì•½ì„œ ìœ„í—˜ë„ í•˜ì´ë¼ì´íŠ¸</h1>

    <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div id="uploadSection"
      style="background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin: 16px 0;">
      <p style="color: var(--muted); margin: 0 0 12px; text-align: center;">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë…ì†Œ ì¡°í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤</p>
      <div style="display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap;">
        <input type="file" id="pdfInput" accept="application/pdf"
          style="padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text); cursor: pointer; font-size: 14px;">
        <button id="sendBtn"
          style="padding: 10px 20px; background: linear-gradient(135deg, #22d3ee, #3b82f6); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s;">ë¶„ì„
          ì‹œì‘</button>
        <button id="resetBtn"
          style="display: none; padding: 10px 20px; background: linear-gradient(135deg, #f97316, #dc2626); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s;">ìƒˆ
          ë¶„ì„</button>
      </div>
      <div id="status"
        style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; display: none;">
      </div>
    </div>

    <p id="fileInfo" style="display: none;">
      <strong style="color: var(--accent);">ë¶„ì„ ë°©ì‹:</strong>
      PDF í…ìŠ¤íŠ¸ë¥¼ AIê°€ ë¶„ì„í•´ JSON í˜•ì‹ì˜ ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì›ë³¸ PDFì— í•˜ì´ë¼ì´íŠ¸ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
    </p>

    <div class="legend">
      <span class="chip"><span class="color-dot" style="background:#ef4444"></span>RED ìœ„í—˜</span>
      <span class="chip"><span class="color-dot" style="background:#f97316"></span>ORANGE ìœ„í—˜</span>
      <span class="chip"><span class="color-dot" style="background:#eab308"></span>YELLOW ìœ„í—˜</span>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <p id="pdf-status">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
      <div id="pdf-container"></div>
    </section>

    <aside class="panel">
      <div class="meta" style="margin-bottom:10px;">
        <h3 style="margin:0;">ìœ„í—˜ ì¡°í•­</h3>
        <span class="chip" style="background:rgba(34,211,238,0.12); border-color:#22d3ee; color:#67e8f9;">ìë™
          í•˜ì´ë¼ì´íŠ¸</span>
      </div>
      <div id="clause-list" class="clause-list"></div>
    </aside>
  </main>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const CMAP_URL = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/';
    const CMAP_PACKED = true;

    const riskPalette = {
      RED: { fill: 'rgba(239,68,68,0.28)', line: '#ef4444', label: 'RED' },
      ORANGE: { fill: 'rgba(249,115,22,0.25)', line: '#f97316', label: 'ORANGE' },
      YELLOW: { fill: 'rgba(234,179,8,0.25)', line: '#eab308', label: 'YELLOW' }
    };

    let pdfUrl = null;
    let externalData = null;

    const normalize = (str = '') => str.replace(/\s+/g, '').replace(/\u00ad/g, '').trim();
    const normalizeText = (text = '') => text.replace(/\s+/g, '').toLowerCase();



    // ğŸ”’ ìˆ«ì/ë‚ ì§œ/ì—°ë½ì²˜ ë“± ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹
    function maskSensitiveInfo(text) {
      if (!text) return "";

      return text
        // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ í˜•íƒœ
        .replace(/\d{6}-\d{7}/g, "******-*******")
        // ì „í™”ë²ˆí˜¸ 010-1234-5678, 02-123-4567 ë“±
        .replace(/\d{2,3}-\d{3,4}-\d{4}/g, "***-****-****")
        // ì´ë©”ì¼
        .replace(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g, "email(ë§ˆìŠ¤í‚¹)")
        // ì—°ì›”ì¼ (2025ë…„ 11ì›” 25ì¼)
        .replace(/\d{2,4}\s*ë…„\s*\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼/g, "YYYYë…„ MMì›” DDì¼")
        // ë‹¨ë… ìˆ«ì ê¸ˆì•¡ (10,000ì› / 10000ì›)
        .replace(/[\d,]{3,}\s*ì›/g, "ê¸ˆì•¡(ë§ˆìŠ¤í‚¹)")
        // ì—°ì† ìˆ«ì(ê³„ì¢Œë²ˆí˜¸ ë“±) 6ìë¦¬ ì´ìƒ
        .replace(/\d{6,}/g, "ìˆ«ì(ë§ˆìŠ¤í‚¹)");
    }

    // ğŸ“‘ "1. ..." "2. ..." í˜•ì‹ ì¡°í•­ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
    function splitIntoClauses(fullText) {
      const lines = (fullText || "").split(/\r?\n/);
      const clauses = [];
      let current = null;

      const headingRegex = /^(\d+)\.\s*(.+)/;  // ì˜ˆ: "1. ê·¼ë¡œê°œì‹œì¼ : ..."

      for (const rawLine of lines) {
        const line = rawLine.trim();
        if (!line) continue;

        const m = line.match(headingRegex);

        if (m) {
          // ì´ì „ ì¡°í•­ ì €ì¥
          if (current) clauses.push(current);

          current = {
            id: `clause_${m[1]}`,       // "clause_1"
            title: line,                // "1. ê·¼ë¡œê°œì‹œì¼ : ..."
            body: ""
          };
        } else if (current) {
          // í˜„ ì¡°í•­ ë‚´ìš©ì— ì´ì–´ ë¶™ì´ê¸°
          current.body += (current.body ? "\n" : "") + line;
        }
      }

      if (current) clauses.push(current);

      // ë§ˆìŠ¤í‚¹ ì ìš© + APIìš© êµ¬ì¡°ë¡œ ë³€í™˜
      return clauses.map(c => {
        const rawText = `${c.title}\n${c.body}`;
        const masked = maskSensitiveInfo(rawText);

        return {
          id: c.id,
          title: c.title,
          text: masked
        };
      });
    }



    const renderClauseList = (clauses) => {
      const host = document.getElementById('clause-list');
      host.innerHTML = '';
      clauses.forEach((item, idx) => {
        const riskKey = String(item['ìœ„í—˜ë„ ìƒ‰ìƒ'] || item['ìœ„í—˜ë„'] || '').toUpperCase();
        const palette = riskPalette[riskKey] || { fill: 'rgba(148,163,184,0.2)', line: '#94a3b8', label: riskKey || 'N/A' };
        const box = document.createElement('article');
        box.className = 'clause';
        box.style.borderColor = palette.line;
        box.innerHTML = `
          <div class="meta">
            <span class="chip" style="border-color:${palette.line}; color:${palette.line}; background:${palette.fill};">${palette.label}</span>
            <span style="color:var(--muted); font-size:12px;">#${idx + 1}</span>
          </div>
          <h4>${item['ì¡°í•­'] || 'ì¡°í•­ ì—†ìŒ'}</h4>
          <p class="note">${(item['ì„¤ëª…'] || '').replace(/\n/g, '<br>')}</p>
        `;
        host.appendChild(box);
      });
    };

    // ë¬¸ìì—´ ìœ ì‚¬ë„ ê³„ì‚° (í•˜ì´ë¼ì´íŠ¸ ë§¤ì¹­ìš©)
    function calculateSimilarity(str1, str2) {
      const norm1 = normalizeText(str1);
      const norm2 = normalizeText(str2);

      if (!norm1 || !norm2) return 0;
      if (norm1 === norm2) return 1.0;

      const shorter = norm1.length < norm2.length ? norm1 : norm2;
      const longer = norm1.length < norm2.length ? norm2 : norm1;

      let matchCount = 0;
      let longerIdx = 0;

      for (let i = 0; i < shorter.length; i++) {
        const ch = shorter[i];
        const foundIdx = longer.indexOf(ch, longerIdx);
        if (foundIdx !== -1) {
          matchCount++;
          longerIdx = foundIdx + 1;
        }
      }
      return matchCount / shorter.length;
    }






    // í…ìŠ¤íŠ¸ ë ˆì´ì–´ í•˜ì´ë¼ì´íŠ¸ (í˜ì´ì§€ ë¬¸ìì—´ ê¸°ë°˜ ë²„ì „)
    const highlightTextLayer = (textLayerDiv, clauses) => {
      if (!textLayerDiv || !clauses || clauses.length === 0) return;

      const spans = Array.from(textLayerDiv.querySelectorAll('span'));
      console.log(`\nğŸ” í•˜ì´ë¼ì´íŠ¸ ì‹œì‘ - span ê°œìˆ˜: ${spans.length}, ì¡°í•­ ê°œìˆ˜: ${clauses.length}`);

      // 1) í˜ì´ì§€ ì „ì²´ ë¬¸ìì—´ + span ì¸ë±ìŠ¤ í…Œì´ë¸” ë§Œë“¤ê¸°
      let pageTextNorm = '';
      const spanInfos = spans.map((span) => {
        const raw = span.textContent || '';
        const norm = normalizeText(raw);        // ê³µë°± ì œê±° + ì†Œë¬¸ì
        const start = pageTextNorm.length;
        const end = start + norm.length;

        pageTextNorm += norm;
        return { span, start, end };
      });

      console.log('ğŸ“ í˜ì´ì§€ ì „ì²´ ë¬¸ìì—´ ê¸¸ì´:', pageTextNorm.length);

      let matchCount = 0;

      // 2) ê° ìœ„í—˜ ì¡°í•­ì„ í˜ì´ì§€ ë¬¸ìì—´ì—ì„œ ìœ„ì¹˜ ê²€ìƒ‰
      clauses.forEach((clause, clauseIdx) => {
        const targetText = clause['ì¡°í•­'] || clause['ë‚´ìš©'] || '';
        if (!targetText) {
          console.log(`âš ï¸ ì¡°í•­ #${clauseIdx + 1}: í…ìŠ¤íŠ¸ ì—†ìŒ`);
          return;
        }

        const riskKey = String(clause['ìœ„í—˜ë„ ìƒ‰ìƒ'] || clause['ìœ„í—˜ë„'] || '').toUpperCase();
        let highlightClass = '';
        if (riskKey.includes('RED')) highlightClass = 'highlight-red';
        else if (riskKey.includes('ORANGE')) highlightClass = 'highlight-orange';
        else if (riskKey.includes('YELLOW')) highlightClass = 'highlight-yellow';

        if (!highlightClass) {
          console.log(`âš ï¸ ì¡°í•­ #${clauseIdx + 1}: ì•Œ ìˆ˜ ì—†ëŠ” ìœ„í—˜ë„ '${riskKey}'`);
          return;
        }

        console.log(`\nğŸ¯ ì¡°í•­ #${clauseIdx + 1} (${riskKey}): ${targetText.slice(0, 80)}...`);

        // "ì œëª©: ë‚´ìš©" í˜•íƒœë©´ ì½œë¡  ë’¤ ë‚´ìš©ë§Œ ì‚¬ìš©
        let coreText = targetText;
        if (targetText.includes(':')) {
          coreText = targetText.split(':').slice(1).join(':').trim();
        }

        const normalizedTarget = normalizeText(coreText);
        if (!normalizedTarget || normalizedTarget.length < 5) {
          console.log('   âœ— í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ì•„ì„œ ìŠ¤í‚µ');
          return;
        }

        // 3) í˜ì´ì§€ ë¬¸ìì—´ì—ì„œ ì´ ì¡°í•­ì´ ë‚˜ì˜¤ëŠ” ìœ„ì¹˜ ì°¾ê¸°
        let pos = pageTextNorm.indexOf(normalizedTarget);
        if (pos === -1) {
          console.log('   âœ— ë§¤ì¹­ ì‹¤íŒ¨ - í˜ì´ì§€ ë¬¸ìì—´ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          return;
        }

        while (pos !== -1) {
          const targetStart = pos;
          const targetEnd = pos + normalizedTarget.length;

          console.log(`   âœ“ ë§¤ì¹­ êµ¬ê°„: [${targetStart}, ${targetEnd})`);

          // 4) ì´ êµ¬ê°„ê³¼ ê²¹ì¹˜ëŠ” spanì—ë§Œ í•˜ì´ë¼ì´íŠ¸ ì ìš©
          spanInfos.forEach(info => {
            if (info.end <= targetStart) return; // infoê°€ íƒ€ê¹ƒ ì•
            if (info.start >= targetEnd) return; // infoê°€ íƒ€ê¹ƒ ë’¤
            // ì—¬ê¸° ë„ë‹¬í•˜ë©´ êµ¬ê°„ì´ ê²¹ì¹˜ëŠ” span
            info.span.classList.add(highlightClass);
            info.span.style.backgroundColor =
              riskKey === 'RED' ? 'rgba(239,68,68,0.4)' :
                riskKey === 'ORANGE' ? 'rgba(249,115,22,0.35)' :
                  'rgba(234,179,8,0.35)';
          });

          matchCount++;
          // ê°™ì€ ë¬¸ì¥ì´ ì—¬ëŸ¬ ë²ˆ ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë‹¤ìŒ ìœ„ì¹˜ë„ íƒìƒ‰
          pos = pageTextNorm.indexOf(normalizedTarget, targetEnd);
        }
      });

      console.log(`\nâœ… í•˜ì´ë¼ì´íŠ¸ ì™„ë£Œ: ${matchCount}/${clauses.length}ê°œ ì¡°í•­ ë§¤ì¹­ë¨\n`);
    };









    const renderDocument = async (customData = null) => {
      const status = document.getElementById('pdf-status');

      if (!pdfUrl) {
        status.textContent = 'PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”';
        return;
      }

      try {
        status.textContent = 'PDFë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        const pdf = await pdfjsLib.getDocument({
          url: pdfUrl,
          cMapUrl: CMAP_URL,
          cMapPacked: CMAP_PACKED
        }).promise;

        const data = customData || externalData || {};
        const clauses = data['ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸'] || data['ë…ì†Œ ì¡°í•­ ë¦¬ìŠ¤íŠ¸'] || data.clauses || [];

        console.log('ğŸ“Š ì‚¬ìš© ì¤‘ì¸ ë¶„ì„ ë°ì´í„°:', data);
        console.log('ğŸ“‹ ìœ„í—˜ ì¡°í•­ ìˆ˜:', clauses.length);

        renderClauseList(clauses);

        const viewer = document.getElementById('pdf-container');
        viewer.innerHTML = '';
        status.textContent = '';

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);

          const viewport = page.getViewport({ scale: 1.5 });
          const pageDiv = document.createElement('div');
          pageDiv.className = 'pdf-page';
          pageDiv.style.width = viewport.width + 'px';
          pageDiv.style.height = viewport.height + 'px';

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          pageDiv.appendChild(canvas);
          viewer.appendChild(pageDiv);

          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;

          const textLayerDiv = document.createElement('div');
          textLayerDiv.className = 'textLayer';
          textLayerDiv.style.width = viewport.width + 'px';
          textLayerDiv.style.height = viewport.height + 'px';
          textLayerDiv.style.setProperty('--scale-factor', viewport.scale);
          pageDiv.appendChild(textLayerDiv);

          const textContent = await page.getTextContent();
          const textLayer = pdfjsLib.renderTextLayer({
            textContentSource: textContent,
            container: textLayerDiv,
            viewport: viewport
          });

          await textLayer.promise;

          console.log(`ğŸ“„ í˜ì´ì§€ ${pageNum} í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë” ì™„ë£Œ â†’ í•˜ì´ë¼ì´íŠ¸`);
          highlightTextLayer(textLayerDiv, clauses);
        }

        status.textContent = `âœ“ PDF ${pdf.numPages}í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ (ìœ„í—˜ ì¡°í•­ ${clauses.length}ê°œ)`;
      } catch (err) {
        console.error('âŒ PDF ë Œë”ë§ ì˜¤ë¥˜:', err);
        status.textContent = `ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`;
      }
    };







    // postMessage í†µì‹  (í•„ìš”ì‹œ ìœ ì§€)
    window.addEventListener('message', (event) => {
      console.log('ğŸ“¨ postMessage ìˆ˜ì‹ :', event.origin);
      if (event.data && event.data.type === 'PDF_ANALYSIS_RESULT') {
        console.log('âœ“ PDF ë¶„ì„ ê²°ê³¼ ìˆ˜ì‹  (postMessage)');
        externalData = event.data.data;
        const viewer = document.getElementById('pdf-container');
        viewer.innerHTML = '';
        renderDocument(event.data.data);
      }
    });

    window.updateAnalysisData = (data) => {
      console.log('âœ“ updateAnalysisData í˜¸ì¶œë¨');
      externalData = data;
      const viewer = document.getElementById('pdf-container');
      viewer.innerHTML = '';
      renderDocument(data);
    };

    // === n8n ì—°ë™ ===
    const WEBHOOK_URL = "https://n8n.dpgtestbed.kr/webhook-test/73f34187-b08f-48fa-960d-ba9ead6c80f7";

    function showStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }





// ----------------------------------- ë°ì´í„° ë³€ê²½



// ğŸ”´ ìƒˆ: LLM JSON â†’ ë·°ì–´ìš© ë°ì´í„°ë¡œ ë³€í™˜
function buildHighlightDataFromModelJson(modelJson) {
  if (!modelJson) return null;

  let risks = [];

  // â‘  ìµœìƒìœ„ê°€ ë°°ì—´ì¸ ê²½ìš° (ì˜ˆ: [ { ... }, { ... } ])
  if (Array.isArray(modelJson)) {
    risks = modelJson;
  } else {
    // â‘¡ ê°ì²´ì¸ ê²½ìš° ê¸°ì¡´ í‚¤ë“¤ ë‹¤ ì§€ì›
    risks =
      modelJson.risks ||
      modelJson["ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸"] ||
      modelJson["ìœ„í—˜ ì¡°í•­ë“¤"] ||
      modelJson["ë…ì†Œ ì¡°í•­ ë¦¬ìŠ¤íŠ¸"] ||
      [];
  }

  if (!Array.isArray(risks) || risks.length === 0) {
    console.warn("âš ï¸ buildHighlightDataFromModelJson: risksê°€ ë¹„ì–´ìˆìŒ", modelJson);
    return { "ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸": [] };
  }

  const mapped = risks.map((r, idx) => {
    const clauseText =
      r.clause ||
      r["ì›ë¬¸ ì¡°í•­"] ||
      r["ì¡°í•­"] ||
      r.text ||
      "";

    const riskColor = (
      r.risk_color ||
      r["ìœ„í—˜ë„ ìƒ‰ìƒ"] ||
      r["ìœ„í—˜ë„"] ||
      r.risk ||
      ""
    )
      .toString()
      .toUpperCase();

    const reason =
      r.reason ||
      r["ì´ ì¡°í•­ì´ ì™œ ìœ„í—˜í•œì§€"] ||
      r["ì´ìœ "] ||
      r["ì„¤ëª…"] ||
      "";

    const easy =
      r.easy_version ||
      r["ì‰½ê²Œ í’€ì–´ì“´ í•´ì„"] ||
      r.easyTranslation ||
      "";

    const summaryArr =
      r.summary_3 ||
      r["3ì¤„ ìš”ì•½"] ||
      r.summary ||
      [];

    const descParts = [];
    if (reason) descParts.push(`ì™œ ìœ„í—˜í•œì§€: ${reason}`);
    if (easy) descParts.push(`ì‰½ê²Œ í’€ì–´ì“´ í•´ì„: ${easy}`);
    if (Array.isArray(summaryArr) && summaryArr.length) {
      const summaryStr = summaryArr
        .map((s, i) => `${i + 1}) ${s}`)
        .join(" ");
      descParts.push(`3ì¤„ ìš”ì•½: ${summaryStr}`);
    }

    return {
      "ì¡°í•­ ë²ˆí˜¸": r.clause_number || r["clause_number"] || r.rank || "",
      "ì¡°í•­ ì œëª©": r.clause_title || r["clause_title"] || r.name || "",
      "ì¡°í•­": clauseText,
      "ìœ„í—˜ë„ ìƒ‰ìƒ": riskColor,
      "ì„¤ëª…": descParts.join("\n"),
    };
  });

  console.log("âœ… buildHighlightDataFromModelJson ê²°ê³¼:", mapped);
  return { "ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸": mapped };
}

// ------------------------------------------------




// ------------------------------------------------


// ğŸ”´ ìƒˆ: n8n ì‘ë‹µ(JSON/ë°°ì—´/ë¬¸ìì—´) ì•ˆì „ íŒŒì‹±
function parseN8nStructuredResult(n8nResult) {
  console.log("ğŸ” n8n ì‘ë‹µ íŒŒì‹± ì‹œì‘:", n8nResult);

  if (!n8nResult) return null;

  let payload = n8nResult;

  // 1) n8nì´ [{ json: {...} }] í˜•íƒœë¡œ ì¤„ ë•Œ
  if (Array.isArray(payload)) {
    const first = payload[0] || {};
    payload = first.json || first;
  }

  // 2) ì§€ê¸ˆì²˜ëŸ¼ { parsed: [...], raw_output: '...' } í˜•íƒœì¼ ë•Œ
  if (Array.isArray(payload.parsed) && payload.parsed.length > 0) {
    console.log("âœ… parsed í•„ë“œ ì‚¬ìš©:", payload.parsed);

    const mapped = payload.parsed.map((r, idx) => ({
      "ì¡°í•­ ë²ˆí˜¸": r.rank || "",
      "ì¡°í•­ ì œëª©": r.name || "",
      "ì¡°í•­": r.clause || "",
      "ìœ„í—˜ë„ ìƒ‰ìƒ": (r.risk || "").toString().toUpperCase(),
      "ì„¤ëª…": "", // í•„ìš”í•˜ë©´ ì—¬ê¸° ë‚˜ì¤‘ì— ì´ìœ  ì¶”ê°€
    }));

    return { "ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸": mapped };
  }

  // 3) ê·¸ ì™¸ ì¼€ì´ìŠ¤: raw_output / output / text ì—ì„œ JSON íŒŒì‹± ì‹œë„
  let modelRaw = payload;

  // 3-1) raw_outputì´ ```json ... ``` í˜•íƒœì¸ ê²½ìš°
  if (typeof payload.raw_output === "string") {
    let clean = payload.raw_output.trim();
    // ë°±í‹± & ì–¸ì–´ íƒœê·¸ ì œê±°
    clean = clean.replace(/```json/gi, "").replace(/```/g, "").trim();
    try {
      modelRaw = JSON.parse(clean);
      console.log("âœ… raw_output JSON íŒŒì‹± ì„±ê³µ");
    } catch (e) {
      console.error("âŒ raw_output JSON íŒŒì‹± ì‹¤íŒ¨:", e);
    }
  } else if (typeof payload === "string") {
    try {
      modelRaw = JSON.parse(payload);
      console.log("âœ… ë¬¸ìì—´ payload JSON íŒŒì‹± ì„±ê³µ");
    } catch (e) {
      console.error("âŒ ë¬¸ìì—´ payload JSON íŒŒì‹± ì‹¤íŒ¨:", e);
    }
  } else if (typeof payload.output === "string") {
    try {
      modelRaw = JSON.parse(payload.output);
      console.log("âœ… output JSON íŒŒì‹± ì„±ê³µ");
    } catch (e) {
      console.error("âŒ output JSON íŒŒì‹± ì‹¤íŒ¨:", e);
    }
  } else if (typeof payload.text === "string") {
    try {
      modelRaw = JSON.parse(payload.text);
      console.log("âœ… text JSON íŒŒì‹± ì„±ê³µ");
    } catch (e) {
      console.error("âŒ text JSON íŒŒì‹± ì‹¤íŒ¨:", e);
    }
  }

  // 4) ìµœì¢…ì ìœ¼ë¡œ LLM JSON â†’ ìš°ë¦¬ í¬ë§·ìœ¼ë¡œ ë³€í™˜
  const highlightData = buildHighlightDataFromModelJson(modelRaw);
  return highlightData;
}


// ------------------------------------------------



    document.getElementById("sendBtn").addEventListener("click", async () => {
      const file = document.getElementById("pdfInput").files[0];
      if (!file) {
        showStatus("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!", "error");
        return;
      }

      const sendBtn = document.getElementById("sendBtn");
      const pdfInput = document.getElementById("pdfInput");
      sendBtn.disabled = true;
      pdfInput.disabled = true;





      try {
        // 1) PDF íŒŒì¼ ì½ê¸°
        showStatus("PDF íŒŒì¼ì„ ì½ëŠ” ì¤‘...", "loading");
        const buffer = await file.arrayBuffer();
        const blob = new Blob([buffer], { type: 'application/pdf' });
        pdfUrl = URL.createObjectURL(blob);

        const fileInfoEl = document.getElementById('fileInfo');
        fileInfoEl.innerHTML = `<strong style="color: var(--accent);">ë¶„ì„ íŒŒì¼:</strong> ${file.name}`;
        fileInfoEl.style.display = 'block';

        // 2) PDF ë¨¼ì € ë Œë”ë§ (ë¹ˆ í•˜ì´ë¼ì´íŠ¸)
        showStatus("PDFë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘...", "loading");
        await renderDocument(null);






        // 3) í…ìŠ¤íŠ¸ ì¶”ì¶œ
        showStatus("PDFì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¤‘...", "loading");
        const pdf = await pdfjsLib.getDocument({
          data: buffer,
          cMapUrl: CMAP_URL,
          cMapPacked: CMAP_PACKED
        }).promise;

        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const txt = await page.getTextContent();
          const strings = txt.items.map(item => item.str).join(" ");
          fullText += strings + "\n";
        }
        console.log("ì¶”ì¶œëœ í…ìŠ¤íŠ¸:", fullText.slice(0, 500));

        // 4) n8nìœ¼ë¡œ ì „ì†¡


        console.log("ì¶”ì¶œëœ í…ìŠ¤íŠ¸:", fullText.slice(0, 500));



        // 3-1) ì „ì²´ í…ìŠ¤íŠ¸ë§Œ ë§ˆìŠ¤í‚¹í•´ì„œ ì“°ê¸° (ì¡°í•­ ë¶„ë¦¬ ì ê¹ OFF)
        const maskedFullText = maskSensitiveInfo(fullText);

        // 4) n8nìœ¼ë¡œ ì „ì†¡ (ë¬¸ì„œ ì „ì²´)
        showStatus("n8nìœ¼ë¡œ ë¶„ì„ ìš”ì²­ ì¤‘...", "loading");
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filename: file.name,
            text: maskedFullText          // â† ì´ì œ clauses ë§ê³  text í•˜ë‚˜ë§Œ ë³´ëƒ„
          }),
        });









        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const n8nResult = await res.json();
        console.log("n8n ì‘ë‹µ(raw):", n8nResult);

        // 5) êµ¬ì¡°í™” JSON íŒŒì‹±
        showStatus("AI ë¶„ì„ ê²°ê³¼ ì •ë¦¬ ì¤‘...", "loading");
        const finalData = parseN8nStructuredResult(n8nResult);

        if (!finalData || !finalData["ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸"] || finalData["ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸"].length === 0) {
          showStatus("ë¶„ì„ ì™„ë£Œ! (ìœ„í—˜ ì¡°í•­ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)", "success");
          console.warn('âš ï¸ ìœ„í—˜ ì¡°í•­ì´ ì—†ê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨');
        } else {
          externalData = finalData;
          const viewer = document.getElementById('pdf-container');
          viewer.innerHTML = '';

          showStatus("í•˜ì´ë¼ì´íŠ¸ ì ìš© ì¤‘...", "loading");
          await renderDocument(finalData);

          const cnt = finalData["ìœ„í—˜ ì¡°í•­ ë¦¬ìŠ¤íŠ¸"].length;
          showStatus(`ë¶„ì„ ì™„ë£Œ! ${cnt}ê°œ ì¡°í•­ í•˜ì´ë¼ì´íŠ¸ë¨`, "success");
          setTimeout(hideStatus, 3000);
        }

        document.getElementById('resetBtn').style.display = 'inline-block';
        sendBtn.style.display = 'none';
        pdfInput.style.display = 'none';

      } catch (error) {
        console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
        showStatus(`ì˜¤ë¥˜: ${error.message}`, "error");
        sendBtn.disabled = false;
        pdfInput.disabled = false;
      }
    });






    document.getElementById("resetBtn").addEventListener("click", () => {
      location.reload();
    });

    // ë¶€ëª¨ ì°½ì— ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
    if (window.parent !== window) {
      window.parent.postMessage({
        type: 'PDF_VIEWER_READY'
      }, '*');
    }
    //-----------------------------------------------------------------------------------
  </script>
</body>

</html>